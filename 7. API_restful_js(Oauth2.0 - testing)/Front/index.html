<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing automatizado</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">

    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-dark">
    <div class="container bg-light rounded-3 p-5 mt-3">
        <h1>🔬Testing automatizado</h1>
        <p>Esta es una prueba automatizada de las funcionalidades de la API RESTful.</p>
        <hr>
        <p class="d-inline">
            Prueba 1: Registro de usuario. Resultado: <strong id="testresult-1"></strong>
            <div id="spinner-1" class="spinner-border text-primary" role="status"></div>
        </p>
        <p class="d-inline">
            Prueba 2: Login de usuario. Resultado: <strong id="testresult-2"></strong>
            <div id="spinner-2" class="spinner-border text-primary" role="status"></div>
        </p>
        <p class="d-inline">
            Prueba 3: Validación de token/key de usuario. Resultado: <strong id="testresult-3"></strong>
            <div id="spinner-3" class="spinner-border text-primary" role="status"></div>
        </p>
    </div>
    <div class="loader"></div>

    <!-- Scripts -->
    <script>
        // Datos de prueba
        var testData = {
            usr_name: "Juan Perez",
            usr_email: "juan.perez@example.com",
            usr_pass: "password123",
            imagen: "img/testuser.png",
            usr_key: "",
        };

        // Funcion fetch para obtener/enviar datos con la API
        async function fetchData(url, method, data) {
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return false;
            }
        }

        // Prueba 1: Registro de usuario
        async function testUserRegistration() {
            // Conversión de imagen de prueba a base64
            fetch(testData.imagen)
            .then(response => response.blob())
            .then(blob => {
                const reader = new FileReader();
                reader.onloadend = async function() {
                    testData.imagen = reader.result;
                    // Muestra contenido de testData.imagen en consola
                    console.log('Imagen en base64:', testData.imagen);

                    // Efectua la llamada a la API
                    const response = await fetchData('../API/api.php/usuarios', 'POST', testData);
                    document.getElementById('spinner-1').classList.add('d-none');
                    if (response.success) {
                        document.getElementById('testresult-1').innerText = '✅ Éxito';
                        document.getElementById('testresult-1').classList.add('text-success');
                    } else if(response.error) {
                        document.getElementById('testresult-1').innerText = '❌ Fallo: '+ response.error;
                        document.getElementById('testresult-1').classList.add('text-danger');
                    }
                };
                reader.readAsDataURL(blob);
            })
            .catch(error => {
                console.error('Error loading image:', error);
            });
        }

        // Prueba 2: Login de usuario
        async function testUserLogin() {
            const response = await fetchData('../API/api.php/login', 'POST', {
                usr_email: testData.usr_email,
                usr_pass: testData.usr_pass
            });
            document.getElementById('spinner-2').classList.add('d-none');
            if (response.success) {
                // Guarda el token/key del usuario
                testData.usr_key = response.success[2];
                document.getElementById('testresult-2').innerText = '✅ Éxito';
                document.getElementById('testresult-2').classList.add('text-success');
            } else if (response.error) {
                document.getElementById('testresult-2').innerText = '❌ Fallo: '+ response.error;
                document.getElementById('testresult-2').classList.add('text-danger');
            }
        }

        // Prueba 3: Validación de token/key
        async function testUserToken() {
            const response = await fetchData('../API_test/api.php/testkey', 'POST', {
                key: testData.usr_key
            });
            document.getElementById('spinner-3').classList.add('d-none');
            if (response.success) {
                document.getElementById('testresult-3').innerText = '✅ Éxito';
                document.getElementById('testresult-3').classList.add('text-success');
            } else if (response.error) {
                document.getElementById('testresult-3').innerText = '❌ Fallo: '+ response.error;
                document.getElementById('testresult-3').classList.add('text-danger');
            }
        }

        // Ejecuta las pruebas en orden
        async function runTests() {
            // Prueba 1: Registro de usuario
            await testUserRegistration();
            // Espera 2 segundos antes de hacer login con el usuario recién registrado
            await new Promise(resolve => setTimeout(resolve, 2000));
            // Prueba 2: Login de usuario
            await testUserLogin();
            // Prueba 3: Validación de token/key
            await testUserToken();
        }
        runTests();

    </script>
</body>
</html>