<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing automatizado</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">

    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-dark">
    <div class="container bg-light rounded-3 p-5 mt-3">
        <h1>ðŸ”¬Testing automatizado</h1>
        <p>Esta es una prueba automatizada de las funcionalidades de la API RESTful.</p>
        <hr>
        <p>Prueba 1: Registro de usuario. Resultado: <strong id="testresult-1" class="loader"></strong></p>
        <p>Prueba 2: Login de usuario. Resultado: <strong id="testresult-2" class="loader"></strong></p>
        <p>Prueba 3: Prueba de token/key de usuario. Resultado: <strong id="testresult-3" class="loader"></strong></p>
    </div>

    <!-- Scripts -->
    <script>
        // Datos de prueba
        var testData = {
            usr_name: "Juan Perez",
            usr_email: "juan.perez@example.com",
            usr_pass: "password123",
            imagen: "img/testuser.png",
            usr_key: "",
        };

        // Funcion fetch para obtener/enviar datos con la API
        async function fetchData(url, method, data) {
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return false;
            }
        }

        // Prueba de registro de usuario
        async function testUserRegistration() {
            // ConversiÃ³n de imagen de prueba a base64
            fetch(testData.imagen)
            .then(response => response.blob())
            .then(blob => {
                const reader = new FileReader();
                reader.onloadend = async function() {
                    testData.imagen = reader.result;
                    // Muestra contenido de testData.imagen en consola
                    console.log('Imagen en base64:', testData.imagen);

                    // Efectua la llamada a la API
                    const response = await fetchData('../API/api.php/usuarios', 'POST', testData);
                    console.log('Registro de usuario:', response);
                    document.getElementById('testresult-1').classList.remove('loader');
                    if (response && response.success) {
                        console.log('Usuario registrado correctamente');
                        document.getElementById('testresult-1').innerText = 'âœ… Ã‰xito';
                        document.getElementById('testresult-1').classList.add('text-success');
                    } else {
                        console.error('Error al registrar usuario:', response ? response.error : 'No response');
                        document.getElementById('testresult-1').innerText = 'âŒ Fallo';
                        document.getElementById('testresult-1').classList.add('text-danger');
                    }
                };
                reader.readAsDataURL(blob);
            })
            .catch(error => {
                console.error('Error loading image:', error);
            });
        }

        // Prueba de login de usuario
        async function testUserLogin() {
            const response = await fetchData('../API/api.php/login', 'POST', {
                usr_email: testData.usr_email,
                usr_pass: testData.usr_pass
            });
            console.log('Login de usuario:', response);
            document.getElementById('testresult-2').classList.remove('loader');
            if (response && response.success) {
                console.log('Usuario logueado correctamente:', response.usuario);
                // Guarda el token/key del usuario
                testData.usr_key = response.usuario[2];
                document.getElementById('testresult-2').innerText = 'âœ… Ã‰xito';
                document.getElementById('testresult-2').classList.add('text-success');
            } else {
                console.error('Error al loguear usuario:', response ? response.error : 'No response');
                document.getElementById('testresult-2').innerText = 'âŒ Fallo';
                document.getElementById('testresult-2').classList.add('text-danger');
            }
        }

        // Prueba de token/key
        async function testUserToken() {
            const response = await fetchData('../API_test/api.php/testkey', 'POST', {
                key: testData.usr_key
            });
            console.log('Token de usuario:', response);
            document.getElementById('testresult-3').classList.remove('loader');
            if (response && response.success) {
                console.log('Token obtenido correctamente:', response.token);
                document.getElementById('testresult-3').innerText = 'âœ… Ã‰xito';
                document.getElementById('testresult-3').classList.add('text-success');
            } else {
                console.error('Error al obtener token:', response ? response.error : 'No response');
                document.getElementById('testresult-3').innerText = 'âŒ Fallo';
                document.getElementById('testresult-3').classList.add('text-danger');
            }
        }

        // Ejecuta las pruebas
        // Registra usuario
        testUserRegistration().finally(() => {
            // Login de usuario
            testUserLogin().finally(() => {
                // Prueba de token/key de usuario
                testUserToken().finally(() => {
                    console.log('Pruebas completadas');
                });
            });    
        });
    </script>
</body>
</html>